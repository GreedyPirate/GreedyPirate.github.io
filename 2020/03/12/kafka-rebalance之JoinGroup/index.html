<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="kafka-rebalance之JoinGroup"><meta name="keywords" content="kafka,中间件,消息"><meta name="author" content="紫夜,undefined"><meta name="copyright" content="紫夜"><title>kafka-rebalance之JoinGroup | 紫夜の博客</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6ba54465c1ff0c31b169e7a89d3dbe37";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#发起请求"><span class="toc-number">2.</span> <span class="toc-text">发起请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GoupCoordinator处理请求"><span class="toc-number">3.</span> <span class="toc-text">GoupCoordinator处理请求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#handleJoinGroup"><span class="toc-number">3.1.</span> <span class="toc-text">handleJoinGroup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#doJoinGroup"><span class="toc-number">3.2.</span> <span class="toc-text">doJoinGroup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addMemberAndRebalance"><span class="toc-number">3.3.</span> <span class="toc-text">addMemberAndRebalance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maybePrepareRebalance"><span class="toc-number">3.4.</span> <span class="toc-text">maybePrepareRebalance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#延迟join"><span class="toc-number">3.5.</span> <span class="toc-text">延迟join</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#延迟任务完成处理"><span class="toc-number">3.5.1.</span> <span class="toc-text">延迟任务完成处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调用回调函数"><span class="toc-number">3.6.</span> <span class="toc-text">调用回调函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#客户端Consumer处理响应"><span class="toc-number">4.</span> <span class="toc-text">客户端Consumer处理响应</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#过程分析"><span class="toc-number">5.1.</span> <span class="toc-text">过程分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#难点分析"><span class="toc-number">5.2.</span> <span class="toc-text">难点分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流程图"><span class="toc-number">5.3.</span> <span class="toc-text">流程图</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ae01.alicdn.com/kf/He0f82cbc452e4e99b7da670575752df0l.png"></div><div class="author-info__name text-center">紫夜</div><div class="author-info__description text-center">stay hungry, stay foolish</div><div class="follow-button"><a href="https://github.com/GreedyPirate" target="_blank">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">67</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">11</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://blog.csdn.net/yj7758423" target="_blank">我的CSDN</a><a class="author-info-links__name text-center" href="https://segmentfault.com/blog/code-craft" target="_blank">膜拜大神</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ae01.alicdn.com/kf/H6e9ae455bca04f4098243e3f73a85c4fb.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">紫夜の博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">kafka-rebalance之JoinGroup</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-12</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kafka-Tutorial/">Kafka Tutorial</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3,210</span><span class="post-meta__separator">|</span><span>Reading time: 15 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在AbstractCoordinator的initiateJoinGroup方法中，通过判断joinFuture为null，发起了JoinGroupRequest请求，本文主要讲解GroupCoordinator对该请求的处理。同样的，源码分为客户端发起请求时的参数，broker端的处理过程，以及consumer对响应的处理</p>
<h1 id="发起请求"><a href="#发起请求" class="headerlink" title="发起请求"></a>发起请求</h1><p>请求的发送代码在AbstractCoordinator的sendJoinGroupRequest方法在，方法比较简单，这里说点简单之外的事情</p>
<ol>
<li>首先确保已知coordinator节点，才能向它发起请求</li>
<li>generation.memberId初始化时为””</li>
<li>protocolType=”consumer”</li>
<li>rebalanceTimeoutMs就是max.poll.interval.ms，这个结论可以从KafkaConsumer初始化ConsumerCoordinator得到</li>
<li>4中的rebalanceTimeoutMs也是不最终客户端请求的超时时间，这里源码作者额外增加了5s</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略部分代码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> RequestFuture&lt;ByteBuffer&gt; <span class="title">initiateJoinGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (joinFuture == <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="comment">// ...</span></span><br><span class="line">        joinFuture = sendJoinGroupRequest();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> joinFuture;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">RequestFuture&lt;ByteBuffer&gt; <span class="title">sendJoinGroupRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 确保已知coordinator节点</span></span><br><span class="line">    <span class="keyword">if</span> (coordinatorUnknown())</span><br><span class="line">        <span class="keyword">return</span> RequestFuture.coordinatorNotAvailable();</span><br><span class="line"></span><br><span class="line">    JoinGroupRequest.Builder requestBuilder = <span class="keyword">new</span> JoinGroupRequest.Builder(</span><br><span class="line">            groupId,</span><br><span class="line">            <span class="keyword">this</span>.sessionTimeoutMs,</span><br><span class="line">            <span class="keyword">this</span>.generation.memberId,</span><br><span class="line">            protocolType(), <span class="comment">// consumer</span></span><br><span class="line">            metadata()).setRebalanceTimeout(<span class="keyword">this</span>.rebalanceTimeoutMs);</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">"Sending JoinGroup (&#123;&#125;) to coordinator &#123;&#125;"</span>, requestBuilder, <span class="keyword">this</span>.coordinator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we override the request timeout using the rebalance timeout since that is the</span></span><br><span class="line">    <span class="comment">// maximum time that it may block on the coordinator. We add an extra 5 seconds for small delays.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> joinGroupTimeoutMs = Math.max(rebalanceTimeoutMs, rebalanceTimeoutMs + <span class="number">5000</span>);</span><br><span class="line">    <span class="keyword">return</span> client.send(coordinator, requestBuilder, joinGroupTimeoutMs)</span><br><span class="line">            .compose(<span class="keyword">new</span> JoinGroupResponseHandler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求的格式的json形式如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"groupId"</span>: <span class="string">"test-group"</span>,</span><br><span class="line">	<span class="attr">"sessionTimeout"</span>: <span class="number">30000</span>,</span><br><span class="line">	<span class="attr">"memberId"</span>: <span class="string">""</span>,</span><br><span class="line">	<span class="attr">"protocolType"</span>: <span class="string">"consumer"</span>,</span><br><span class="line">	<span class="attr">"groupProtocols"</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			"name": "range", // PartitionAssignor的name</span><br><span class="line">			"metadata": &#123;</span><br><span class="line">				"version": 0,</span><br><span class="line">				"topic": "foo,bar", // 订阅的topic</span><br><span class="line">				"user_data": null // 通常为null</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	"rebalanceTimeout": 10000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="GoupCoordinator处理请求"><a href="#GoupCoordinator处理请求" class="headerlink" title="GoupCoordinator处理请求"></a>GoupCoordinator处理请求</h1><p>JoinGroupRequest由GoupCoordinator所在的broker处理，入口方法为handleJoinGroupRequest，下面的源码省略了认证相关，可以看出该方法做了2件事：定义响应回调，调用handleJoinGroup方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">handleJoinGroupRequest</span><span class="params">(request: RequestChannel.Request)</span> </span>&#123;</span><br><span class="line">    val joinGroupRequest = request.body[JoinGroupRequest]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the callback for sending a join-group response</span></span><br><span class="line">    <span class="function">def <span class="title">sendResponseCallback</span><span class="params">(joinResult: JoinGroupResult)</span> </span>&#123;</span><br><span class="line">      val members = joinResult.members map &#123; <span class="keyword">case</span> (memberId, metadataArray) =&gt; (memberId, ByteBuffer.wrap(metadataArray)) &#125;</span><br><span class="line">      <span class="function">def <span class="title">createResponse</span><span class="params">(requestThrottleMs: Int)</span>: AbstractResponse </span>= &#123;</span><br><span class="line">        val responseBody = <span class="keyword">new</span> JoinGroupResponse(requestThrottleMs, joinResult.error, joinResult.generationId,</span><br><span class="line">          joinResult.subProtocol, joinResult.memberId, joinResult.leaderId, members.asJava)</span><br><span class="line"></span><br><span class="line">        trace(<span class="string">"Sending join group response %s for correlation id %d to client %s."</span></span><br><span class="line">          .format(responseBody, request.header.correlationId, request.header.clientId))</span><br><span class="line">        responseBody</span><br><span class="line">      &#125;</span><br><span class="line">      sendResponseMaybeThrottle(request, createResponse)</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// let the coordinator handle join-group</span></span><br><span class="line">  val protocols = joinGroupRequest.groupProtocols().asScala.map(protocol =&gt;</span><br><span class="line">    (protocol.name, Utils.toArray(protocol.metadata))).toList</span><br><span class="line">  groupCoordinator.handleJoinGroup(</span><br><span class="line">    joinGroupRequest.groupId,</span><br><span class="line">    joinGroupRequest.memberId,</span><br><span class="line">    request.header.clientId,</span><br><span class="line">    request.session.clientAddress.toString,</span><br><span class="line">    joinGroupRequest.rebalanceTimeout,</span><br><span class="line">    joinGroupRequest.sessionTimeout,</span><br><span class="line">    joinGroupRequest.protocolType, <span class="comment">// consumer</span></span><br><span class="line">    protocols,</span><br><span class="line">    sendResponseCallback)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="handleJoinGroup"><a href="#handleJoinGroup" class="headerlink" title="handleJoinGroup"></a>handleJoinGroup</h2><p>handleJoinGroup的核心逻辑是校验和调用doJoinGroup，关于校验这里说2点</p>
<ol>
<li>groupId不能为null，也不能是””</li>
<li>sessionTimeoutMs默认必须在6000-300000 即6s-5min之间，当然你也可以修改group.min.session.timeout.ms，group.max.session.timeout.ms来调整区间</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">handleJoinGroup</span><span class="params">(groupId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      memberId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      clientId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      clientHost: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      rebalanceTimeoutMs: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                      sessionTimeoutMs: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                      protocolType: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      protocols: List[(String, Array[Byte])</span>],</span></span><br><span class="line"><span class="function">                      responseCallback: JoinCallback): Unit </span>= &#123;</span><br><span class="line">    validateGroupStatus(groupId, ApiKeys.JOIN_GROUP).foreach &#123; error =&gt;</span><br><span class="line">      responseCallback(joinError(memberId, error))</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sessionTimeoutMs默认必须在6000-300000 即6s-5min之间</span></span><br><span class="line">    <span class="keyword">if</span> (sessionTimeoutMs &lt; groupConfig.groupMinSessionTimeoutMs ||</span><br><span class="line">      sessionTimeoutMs &gt; groupConfig.groupMaxSessionTimeoutMs) &#123;</span><br><span class="line">      responseCallback(joinError(memberId, Errors.INVALID_SESSION_TIMEOUT))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 第一个组消费者来这 group不存在并且member id=""，那么会创建group，然后调用doJoinGroup</span></span><br><span class="line">      <span class="comment">// 之后的组消费者之间走doJoinGroup</span></span><br><span class="line">      groupManager.getGroup(groupId) match &#123;</span><br><span class="line">        <span class="keyword">case</span> None =&gt;</span><br><span class="line">          <span class="comment">// memberId已存在，group为空，只能说明是错误的请求</span></span><br><span class="line">          <span class="keyword">if</span> (memberId != JoinGroupRequest.UNKNOWN_MEMBER_ID) &#123;</span><br><span class="line">            responseCallback(joinError(memberId, Errors.UNKNOWN_MEMBER_ID))</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果是新的group，新建一个GroupMetadata，并且GroupState为Empty，之后添加到groupManager的groupMetadataCache</span></span><br><span class="line">            val group = groupManager.addGroup(<span class="keyword">new</span> GroupMetadata(groupId, initialState = Empty))</span><br><span class="line">            doJoinGroup(group, memberId, clientId, clientHost, rebalanceTimeoutMs, sessionTimeoutMs, protocolType, protocols, responseCallback)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">case</span> <span class="title">Some</span><span class="params">(group)</span> </span>=&gt;</span><br><span class="line">          doJoinGroup(group, memberId, clientId, clientHost, rebalanceTimeoutMs, sessionTimeoutMs, protocolType, protocols, responseCallback)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="doJoinGroup"><a href="#doJoinGroup" class="headerlink" title="doJoinGroup"></a>doJoinGroup</h2><p>核心方法都在doJoinGroup方法中，此处省略了许多校验的代码，而group的状态此时为Empty，我们直接看该条件分支即可<br>此时memberId为空，也就是JoinGroupRequest.UNKNOWN_MEMBER_ID，因此这里仅调用addMemberAndRebalance方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">doJoinGroup</span><span class="params">(group: GroupMetadata,</span></span></span><br><span class="line"><span class="function"><span class="params">                          memberId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                          clientId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                          clientHost: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                          rebalanceTimeoutMs: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                          sessionTimeoutMs: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                          protocolType: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                          protocols: List[(String, Array[Byte])</span>],</span></span><br><span class="line"><span class="function">                          responseCallback: JoinCallback) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    group.currentState match &#123;</span><br><span class="line">      <span class="keyword">case</span> Dead =&gt;</span><br><span class="line">        responseCallback(joinError(memberId, Errors.UNKNOWN_MEMBER_ID))</span><br><span class="line">      <span class="keyword">case</span> PreparingRebalance =&gt;</span><br><span class="line">       	<span class="comment">// 省略...</span></span><br><span class="line">      <span class="keyword">case</span> CompletingRebalance =&gt;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">      <span class="keyword">case</span> Empty | Stable =&gt;</span><br><span class="line">        <span class="keyword">if</span> (memberId == JoinGroupRequest.UNKNOWN_MEMBER_ID) &#123;</span><br><span class="line">          <span class="comment">// if the member id is unknown, register the member to the group</span></span><br><span class="line">          addMemberAndRebalance(rebalanceTimeoutMs, sessionTimeoutMs, clientId, clientHost, protocolType,</span><br><span class="line">            protocols, group, responseCallback)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          val member = group.get(memberId)</span><br><span class="line">          <span class="keyword">if</span> (group.isLeader(memberId) || !member.matches(protocols)) &#123;</span><br><span class="line">            updateMemberAndRebalance(group, member, protocols, responseCallback)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            responseCallback(JoinGroupResult(</span><br><span class="line">              members = Map.empty,</span><br><span class="line">              memberId = memberId,</span><br><span class="line">              generationId = group.generationId,</span><br><span class="line">              subProtocol = group.protocolOrNull,</span><br><span class="line">              leaderId = group.leaderOrNull,</span><br><span class="line">              error = Errors.NONE))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (group.is(PreparingRebalance))</span><br><span class="line">      joinPurgatory.checkAndComplete(GroupKey(group.groupId))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="addMemberAndRebalance"><a href="#addMemberAndRebalance" class="headerlink" title="addMemberAndRebalance"></a>addMemberAndRebalance</h2><p>addMemberAndRebalance首先初始化了memberId，可以看到是clientId拼接一个UUID，然后封装成了一个MemberMetadata对象，这是组成员的元信息对象，之后添加到GroupMetadata中<br>注意这里的回调函数传给了awaitingJoinCallback变量，rebalance的处理在maybePrepareRebalance中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">addMemberAndRebalance</span><span class="params">(rebalanceTimeoutMs: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    sessionTimeoutMs: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    clientId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    clientHost: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    protocolType: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    protocols: List[(String, Array[Byte])</span>],</span></span><br><span class="line"><span class="function">                                    group: GroupMetadata,</span></span><br><span class="line"><span class="function">                                    callback: JoinCallback) </span>= &#123;</span><br><span class="line">    <span class="comment">// memberId = clientId-UUID</span></span><br><span class="line">    val memberId = clientId + <span class="string">"-"</span> + group.generateMemberIdSuffix</span><br><span class="line">    <span class="comment">// 组成员的元信息</span></span><br><span class="line">    val member = <span class="keyword">new</span> MemberMetadata(memberId, group.groupId, clientId, clientHost, rebalanceTimeoutMs,</span><br><span class="line">      sessionTimeoutMs, protocolType, protocols)</span><br><span class="line">    member.awaitingJoinCallback = callback</span><br><span class="line">    <span class="comment">// update the newMemberAdded flag to indicate that the join group can be further delayed</span></span><br><span class="line">    <span class="keyword">if</span> (group.is(PreparingRebalance) &amp;&amp; group.generationId == <span class="number">0</span>)</span><br><span class="line">      group.newMemberAdded = <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">    group.add(member)</span><br><span class="line">    maybePrepareRebalance(group)</span><br><span class="line">    member</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add方法很简单，但要关注leaderId的赋值，它表示第一个consumer就是消费者组的leader，也就是第一个consumer为消费者组的leader member<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">add</span><span class="params">(member: MemberMetadata)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (members.isEmpty)</span><br><span class="line">	  <span class="keyword">this</span>.protocolType = Some(member.protocolType)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">assert</span>(groupId == member.groupId)</span><br><span class="line">	<span class="keyword">assert</span>(<span class="keyword">this</span>.protocolType.orNull == member.protocolType)</span><br><span class="line">	<span class="keyword">assert</span>(supportsProtocols(member.protocols))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (leaderId.isEmpty)</span><br><span class="line">	  leaderId = Some(member.memberId)   <span class="comment">// 来的第一个就是leader ...</span></span><br><span class="line">	members.put(member.memberId, member) <span class="comment">// memberId为key MemberMetadata为value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="maybePrepareRebalance"><a href="#maybePrepareRebalance" class="headerlink" title="maybePrepareRebalance"></a>maybePrepareRebalance</h2><p>maybePrepareRebalance仅仅是做了一个判断：当前组状态是Stable, CompletingRebalance, Empty其中之一，才可以开始rebalance，满足条件就调用prepareRebalance</p>
<p>prepareRebalance方法在第一个consumer入组时创建一个InitialDelayedJoin，它会等待group.initial.rebalance.delay.ms<br>这个参数也是为消费者启动时的rebalance优化，因为每启动一个consumer都相当于加入一个组成员，需要进行一次rebalance，这无疑很浪费，这里等待一段时间再开始PreparingRebalance<br>之后的消费者创建的是DelayedJoin，到期时间就是rebalanceTimeoutMs，即max.poll.interval.ms</p>
<p>此时group的状态由Empty转换为了PreparingRebalance</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">maybePrepareRebalance</span><span class="params">(group: GroupMetadata)</span> </span>&#123;</span><br><span class="line">    group.inLock &#123;</span><br><span class="line">      <span class="keyword">if</span> (group.canRebalance)</span><br><span class="line">        prepareRebalance(group)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">prepareRebalance</span><span class="params">(group: GroupMetadata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// if any members are awaiting sync, cancel their request and have them rejoin</span></span><br><span class="line">    <span class="keyword">if</span> (group.is(CompletingRebalance))</span><br><span class="line">      resetAndPropagateAssignmentError(group, Errors.REBALANCE_IN_PROGRESS)</span><br><span class="line"></span><br><span class="line">    val delayedRebalance = <span class="keyword">if</span> (group.is(Empty))</span><br><span class="line">      <span class="keyword">new</span> InitialDelayedJoin(<span class="keyword">this</span>,</span><br><span class="line">        joinPurgatory,</span><br><span class="line">        group,</span><br><span class="line">        groupConfig.groupInitialRebalanceDelayMs,</span><br><span class="line">        groupConfig.groupInitialRebalanceDelayMs,</span><br><span class="line">        max(group.rebalanceTimeoutMs - groupConfig.groupInitialRebalanceDelayMs, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">new</span> DelayedJoin(<span class="keyword">this</span>, group, group.rebalanceTimeoutMs)</span><br><span class="line">    <span class="comment">// 从Empty转变为PreparingRebalance</span></span><br><span class="line">    group.transitionTo(PreparingRebalance)</span><br><span class="line"></span><br><span class="line">    val groupKey = GroupKey(group.groupId)</span><br><span class="line">    joinPurgatory.tryCompleteElseWatch(delayedRebalance, Seq(groupKey))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="延迟join"><a href="#延迟join" class="headerlink" title="延迟join"></a>延迟join</h2><p>joinPurgatory可以理解为一个延迟队列，那么直接看InitialDelayedJoin的onComplete方法，大概意思就是在group.initial.rebalance.delay.ms时间内，它会一直等待消费者入组，超时后后调用父类的onComplete，而InitialDelayedJoin的父类是DelayedJoin，它的onComplete会调用GroupCoordinator的onCompleteJoin方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">private[group] class InitialDelayedJoin(coordinator: GroupCoordinator,</span><br><span class="line">                                        purgatory: DelayedOperationPurgatory[DelayedJoin],</span><br><span class="line">                                        group: GroupMetadata,</span><br><span class="line">                                        configuredRebalanceDelay: Int,</span><br><span class="line">                                        delayMs: Int,</span><br><span class="line">                                        remainingMs: Int) <span class="function">extends <span class="title">DelayedJoin</span><span class="params">(coordinator, group, delayMs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">override def <span class="title">tryComplete</span><span class="params">()</span>: Boolean </span>= <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">  <span class="function">override def <span class="title">onComplete</span><span class="params">()</span>: Unit </span>= &#123;</span><br><span class="line">    group.inLock  &#123;</span><br><span class="line">      <span class="comment">// 是继续等待还是直接结束DelayedJoin</span></span><br><span class="line">      <span class="keyword">if</span> (group.newMemberAdded &amp;&amp; remainingMs != <span class="number">0</span>) &#123;</span><br><span class="line">        group.newMemberAdded = <span class="keyword">false</span></span><br><span class="line">        val delay = min(configuredRebalanceDelay, remainingMs)</span><br><span class="line">        val remaining = max(remainingMs - delayMs, <span class="number">0</span>)</span><br><span class="line">        purgatory.tryCompleteElseWatch(<span class="keyword">new</span> InitialDelayedJoin(coordinator,</span><br><span class="line">          purgatory,</span><br><span class="line">          group,</span><br><span class="line">          configuredRebalanceDelay,</span><br><span class="line">          delay,</span><br><span class="line">          remaining</span><br><span class="line">        ), Seq(GroupKey(group.groupId)))</span><br><span class="line">      &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">super</span>.onComplete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private[group] class DelayedJoin(coordinator: GroupCoordinator,</span><br><span class="line">                                 group: GroupMetadata,</span><br><span class="line">                                 rebalanceTimeout: Long) <span class="function">extends <span class="title">DelayedOperation</span><span class="params">(rebalanceTimeout, Some(group.lock)</span>) </span>&#123;</span><br><span class="line">  <span class="function">override def <span class="title">tryComplete</span><span class="params">()</span>: Boolean </span>= coordinator.tryCompleteJoin(group, forceComplete _)</span><br><span class="line">  <span class="function">override def <span class="title">onExpiration</span><span class="params">()</span> </span>= coordinator.onExpireJoin()</span><br><span class="line">  <span class="function">override def <span class="title">onComplete</span><span class="params">()</span> </span>= coordinator.onCompleteJoin(group)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="延迟任务完成处理"><a href="#延迟任务完成处理" class="headerlink" title="延迟任务完成处理"></a>延迟任务完成处理</h3><p>GroupCoordinator的onCompleteJoin方法源码如下，它的大概意思是响应每一个consumer的请求，这里主要关注JoinGroupResult的第一个参数：leader member的元信息，是leader时才返回currentMemberMetadata(所有组成员的元信息)，也就是说GroupCoordinator只告诉了leader consumer组成员的元信息，原因在下文会揭晓<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">onCompleteJoin</span><span class="params">(group: GroupMetadata)</span> </span>&#123;</span><br><span class="line">    group.inLock &#123;</span><br><span class="line">      <span class="comment">// remove any members who haven't joined the group yet</span></span><br><span class="line">      group.notYetRejoinedMembers.foreach &#123; failedMember =&gt;</span><br><span class="line">        removeHeartbeatForLeavingMember(group, failedMember)</span><br><span class="line">        group.remove(failedMember.memberId)</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> cut the socket connection to the client</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!group.is(Dead)) &#123;</span><br><span class="line">        group.initNextGeneration()</span><br><span class="line">        <span class="keyword">if</span> (group.is(Empty)) &#123;</span><br><span class="line">          info(s<span class="string">"Group $&#123;group.groupId&#125; with generation $&#123;group.generationId&#125; is now empty "</span> +</span><br><span class="line">            s<span class="string">"($&#123;Topic.GROUP_METADATA_TOPIC_NAME&#125;-$&#123;partitionFor(group.groupId)&#125;)"</span>)</span><br><span class="line"></span><br><span class="line">          groupManager.storeGroup(group, Map.empty, error =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (error != Errors.NONE) &#123;</span><br><span class="line">              warn(s<span class="string">"Failed to write empty metadata for group $&#123;group.groupId&#125;: $&#123;error.message&#125;"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          info(s<span class="string">"Stabilized group $&#123;group.groupId&#125; generation $&#123;group.generationId&#125; "</span> +</span><br><span class="line">            s<span class="string">"($&#123;Topic.GROUP_METADATA_TOPIC_NAME&#125;-$&#123;partitionFor(group.groupId)&#125;)"</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (member &lt;- group.allMemberMetadata) &#123;</span><br><span class="line">            <span class="keyword">assert</span>(member.awaitingJoinCallback != <span class="keyword">null</span>)</span><br><span class="line">            val joinResult = JoinGroupResult(</span><br><span class="line">              members = <span class="keyword">if</span> (group.isLeader(member.memberId)) &#123;</span><br><span class="line">                group.currentMemberMetadata</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Map.empty</span><br><span class="line">              &#125;,</span><br><span class="line">              memberId = member.memberId,</span><br><span class="line">              generationId = group.generationId,</span><br><span class="line">              subProtocol = group.protocolOrNull,</span><br><span class="line">              leaderId = group.leaderOrNull,</span><br><span class="line">              error = Errors.NONE)</span><br><span class="line"></span><br><span class="line">            member.awaitingJoinCallback(joinResult)</span><br><span class="line">            member.awaitingJoinCallback = <span class="keyword">null</span></span><br><span class="line">            completeAndScheduleNextHeartbeatExpiration(group, member)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里还要关注一下initNextGeneration方法，generationId+1好理解，selectProtocol是因为每个consumer的分配策略可能不一样，selectProtocol用于投票选举一个PartitionAssignor<br>最后要关注的一点是组状态由PreparingRebalance转变为了CompletingRebalance，也就是所有消费者都进入组内了，等待GroupCoordinator分配分区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">initNextGeneration</span><span class="params">()</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">assert</span>(notYetRejoinedMembers == List.empty[MemberMetadata])</span><br><span class="line">    <span class="keyword">if</span> (members.nonEmpty) &#123;</span><br><span class="line">      generationId += <span class="number">1</span></span><br><span class="line">      protocol = Some(selectProtocol)</span><br><span class="line">      transitionTo(CompletingRebalance)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      generationId += <span class="number">1</span></span><br><span class="line">      protocol = None</span><br><span class="line">      transitionTo(Empty)</span><br><span class="line">    &#125;</span><br><span class="line">    receivedConsumerOffsetCommits = <span class="keyword">false</span></span><br><span class="line">    receivedTransactionalOffsetCommits = <span class="keyword">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用回调函数"><a href="#调用回调函数" class="headerlink" title="调用回调函数"></a>调用回调函数</h2><p>上面调用的awaitingJoinCallback，其实就是sendResponseCallback，最终的响应返回值JoinGroupResponse如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">sendResponseCallback</span><span class="params">(joinResult: JoinGroupResult)</span> </span>&#123;</span><br><span class="line">  val members = joinResult.members map &#123; <span class="keyword">case</span> (memberId, metadataArray) =&gt; (memberId, ByteBuffer.wrap(metadataArray)) &#125;</span><br><span class="line">  <span class="function">def <span class="title">createResponse</span><span class="params">(requestThrottleMs: Int)</span>: AbstractResponse </span>= &#123;</span><br><span class="line">    val responseBody = <span class="keyword">new</span> JoinGroupResponse(requestThrottleMs, joinResult.error, joinResult.generationId,</span><br><span class="line">      joinResult.subProtocol, joinResult.memberId, joinResult.leaderId, members.asJava)</span><br><span class="line">    responseBody</span><br><span class="line">  &#125;</span><br><span class="line">  sendResponseMaybeThrottle(request, createResponse)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="客户端Consumer处理响应"><a href="#客户端Consumer处理响应" class="headerlink" title="客户端Consumer处理响应"></a>客户端Consumer处理响应</h1><p>consumer端处理响应的原理：在最开始的sendJoinGroupRequest方法中，除了发送请求，还定义了响应的处理器，我们只关注Errors为NONE的情况，主要做了2件事</p>
<ol>
<li>初始化了generation，它可以理解为rebalance的次数，版本号</li>
<li>根据server返回的leader memberId判断，如果当前consumer就是leader，调用onJoinLeader，否则调用onJoinFollower</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinGroupResponseHandler</span> <span class="keyword">extends</span> <span class="title">CoordinatorResponseHandler</span>&lt;<span class="title">JoinGroupResponse</span>, <span class="title">ByteBuffer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(JoinGroupResponse joinResponse, RequestFuture&lt;ByteBuffer&gt; future)</span> </span>&#123;</span><br><span class="line">        Errors error = joinResponse.error();</span><br><span class="line">        <span class="keyword">if</span> (error == Errors.NONE) &#123;</span><br><span class="line">            sensors.joinLatency.record(response.requestLatencyMs());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (state != MemberState.REBALANCING) &#123;</span><br><span class="line">                    <span class="comment">// if the consumer was woken up before a rebalance completes, we may have already left</span></span><br><span class="line">                    <span class="comment">// the group. In this case, we do not want to continue with the sync group.</span></span><br><span class="line">                    future.raise(<span class="keyword">new</span> UnjoinedGroupException());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    AbstractCoordinator.<span class="keyword">this</span>.generation = <span class="keyword">new</span> Generation(joinResponse.generationId(),</span><br><span class="line">                            joinResponse.memberId(), joinResponse.groupProtocol());</span><br><span class="line">                    <span class="keyword">if</span> (joinResponse.isLeader()) &#123;</span><br><span class="line">                        onJoinLeader(joinResponse).chain(future);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onJoinFollower().chain(future);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == xxx) &#123;</span><br><span class="line">        	<span class="comment">// 其他错误处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onJoinLeader和onJoinFollower都是发送了一个SyncGroupRequest请求，唯一的区别是，onJoinLeader会计算分配方案，传给SyncGroupRequest请求，而onJoinFollower传入的是一个emptyMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RequestFuture&lt;ByteBuffer&gt; <span class="title">onJoinLeader</span><span class="params">(JoinGroupResponse joinResponse)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// perform the leader synchronization and send back the assignment for the group</span></span><br><span class="line">        Map&lt;String, ByteBuffer&gt; groupAssignment = performAssignment(joinResponse.leaderId(), joinResponse.groupProtocol(),</span><br><span class="line">                joinResponse.members());</span><br><span class="line"></span><br><span class="line">        SyncGroupRequest.Builder requestBuilder =</span><br><span class="line">                <span class="keyword">new</span> SyncGroupRequest.Builder(groupId, generation.generationId, generation.memberId, groupAssignment);</span><br><span class="line">        log.debug(<span class="string">"Sending leader SyncGroup to coordinator &#123;&#125;: &#123;&#125;"</span>, <span class="keyword">this</span>.coordinator, requestBuilder);</span><br><span class="line">        <span class="keyword">return</span> sendSyncGroupRequest(requestBuilder);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> RequestFuture.failure(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestFuture&lt;ByteBuffer&gt; <span class="title">onJoinFollower</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// send follower's sync group with an empty assignment</span></span><br><span class="line">    SyncGroupRequest.Builder requestBuilder =</span><br><span class="line">            <span class="keyword">new</span> SyncGroupRequest.Builder(groupId, generation.generationId, generation.memberId,</span><br><span class="line">                    Collections.&lt;String, ByteBuffer&gt;emptyMap());</span><br><span class="line">    log.debug(<span class="string">"Sending follower SyncGroup to coordinator &#123;&#125;: &#123;&#125;"</span>, <span class="keyword">this</span>.coordinator, requestBuilder);</span><br><span class="line">    <span class="keyword">return</span> sendSyncGroupRequest(requestBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="过程分析"><a href="#过程分析" class="headerlink" title="过程分析"></a>过程分析</h2><p>消费者发送JoinGroupRequest请求的主要作用是向GoupCoordinator上报的订阅信息，而GoupCoordinator处理的核心逻辑就是addMemberAndRebalance，具体是封装消费者组成员的信息为MemberMetadata，将其添加到GroupMetadata中，<br>并在此时确定第一个消费者为leader，之后的操作可以理解为将rebalance操作封装成一个DelayedJoin任务，放入延迟队列中，此时消费者组状态由Empty转变为PreparingRebalance，在延迟任务完成时，才返回给客户响应，响应的主要内容主要是leader member的元信息，消费者组的元信息。<br>客户端(consumer)接收到响应后，主要查看broker返回的leader memberId是不是就是自己，如果是，调用onJoinLeader，它会按分区分配算法计算每个消费者的分区，并再次发送一个SyncGroupRequest请求；相反，如果自己不是leader member，调用的是onJoinFollower，虽然它也发送了SyncGroupRequest请求，但是它的分配方案是空的。</p>
<p>那么为什么要发送一个空的SyncGroupRequest呢？ 这是因为GoupCoordinator只认可leader member的分配方案，其他consumer发送空的SyncGroupRequest只是为了让GoupCoordinator返回leader member的分配方案，即对非leader member的consumer来说，空的SyncGroupRequest不是重点，该请求的响应里包含的分区分配才是重点</p>
<h2 id="难点分析"><a href="#难点分析" class="headerlink" title="难点分析"></a>难点分析</h2><p>JoinGroupRequest最难理解的地方是对InitialDelayedJoin和DelayedJoin的理解，InitialDelayedJoin在早期的kafka源码并不存在，是后来考虑到项目启动时会触发多次rebalance，因此在kafka的server.properties配置文件中最后一行配置：group.initial.rebalance.delay.ms，设置一定的延迟时间是有意义的，而在改时间超时后，会触发父类DelayedJoin的onComplete，它会调用GroupCoordinator的onCompleteJoin，这里面才会返回给所有consumer JoinGroupRequest请求的响应</p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p><img src="https://pic.downk.cc/item/5ea294a8c2a9a83be5578794.png" alt="join_group"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">紫夜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://greedypirate.github.io/2020/03/12/kafka-rebalance之JoinGroup/">https://greedypirate.github.io/2020/03/12/kafka-rebalance之JoinGroup/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kafka/">kafka</a><a class="post-meta__tags" href="/tags/中间件/">中间件</a><a class="post-meta__tags" href="/tags/消息/">消息</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://ae01.alicdn.com/kf/H50b5d4d79e454447974210dae2d054435.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://ae01.alicdn.com/kf/H45f5b133580045879faaa5fcbe9b598fu.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b6532776de86c85" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/03/12/kafka-rebalance之SyncGroup/"><i class="fa fa-chevron-left">  </i><span>kafka-rebalance之SyncGroup</span></a></div><div class="next-post pull-right"><a href="/2020/03/11/kafka消费者-获取Coordinator/"><span>kafka消费者-获取Coordinator</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '0349a7a18b86f2a653e3',
  clientSecret: '567ba8cefbe2ecffbbc04e676652ae4b43e7f952',
  repo: 'GreedyPirate.github.io',
  owner: 'GreedyPirate',
  admin: 'GreedyPirate',
  id: md5(decodeURI(location.pathname)),
  language: ''
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By 紫夜</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://GreedyPirate.github.io">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>