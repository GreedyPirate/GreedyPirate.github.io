<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="kafka消费者-心跳流程全解析"><meta name="keywords" content="kafka,中间件,消息"><meta name="author" content="紫夜,undefined"><meta name="copyright" content="紫夜"><title>kafka消费者-心跳流程全解析 | 紫夜の博客</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6ba54465c1ff0c31b169e7a89d3dbe37";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#源码"><span class="toc-number">2.</span> <span class="toc-text">源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#心跳状态类"><span class="toc-number">2.1.</span> <span class="toc-text">心跳状态类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#心跳线程"><span class="toc-number">3.</span> <span class="toc-text">心跳线程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#心跳核心方法"><span class="toc-number">3.1.</span> <span class="toc-text">心跳核心方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#心跳请求"><span class="toc-number">3.1.1.</span> <span class="toc-text">心跳请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#coordinator处理心跳请求"><span class="toc-number">4.</span> <span class="toc-text">coordinator处理心跳请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#延迟队列"><span class="toc-number">4.0.1.</span> <span class="toc-text">延迟队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#延迟任务DelayedHeartbeat"><span class="toc-number">4.0.2.</span> <span class="toc-text">延迟任务DelayedHeartbeat</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#回到Consumer端的心跳线程"><span class="toc-number">4.1.</span> <span class="toc-text">回到Consumer端的心跳线程</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ae01.alicdn.com/kf/He0f82cbc452e4e99b7da670575752df0l.png"></div><div class="author-info__name text-center">紫夜</div><div class="author-info__description text-center">stay hungry, stay foolish</div><div class="follow-button"><a href="https://github.com/GreedyPirate" target="_blank">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">67</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">11</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://blog.csdn.net/yj7758423" target="_blank">我的CSDN</a><a class="author-info-links__name text-center" href="https://segmentfault.com/blog/code-craft" target="_blank">膜拜大神</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ae01.alicdn.com/kf/H6e9ae455bca04f4098243e3f73a85c4fb.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">紫夜の博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">kafka消费者-心跳流程全解析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kafka-Tutorial/">Kafka Tutorial</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2,503</span><span class="post-meta__separator">|</span><span>Reading time: 12 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Consumer需要和Coordinator保持心跳，来证明当前消费者线程存活，有消费消息的能力，但心跳又不止这么简单，它也是Coordinator下发rebalance请求的通道，同时Consumer利用心跳也可以主动离开消费者组</p>
<p>在Consumer端关于心跳的2个重要类为HeartbeatThread和Heartbeat，前者是心跳线程，后者用于记录心跳信息，Consumer poll时间，通过配置计算下一次心跳时间，计算Consumer两次poll的间隔是否超出maxPollIntervalMs</p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><h2 id="心跳状态类"><a href="#心跳状态类" class="headerlink" title="心跳状态类"></a>心跳状态类</h2><p>Heartbeat分为2部分，前面是配置参数相关，后面用于记录心跳与拉取过程中的时间点<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Heartbeat</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> sessionTimeoutMs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> heartbeatIntervalMs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxPollIntervalMs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> retryBackoffMs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上一次心跳发送时间，volatile用于监控读取</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastHeartbeatSend; <span class="comment">// volatile since it is read by metrics</span></span><br><span class="line">    <span class="comment">// 上一次心跳响应接收时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastHeartbeatReceive;</span><br><span class="line">    <span class="comment">// session重置/初始化的实际</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastSessionReset;</span><br><span class="line">    <span class="comment">// consumer 上一次poll的实际</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastPoll;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> heartbeatFailed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面先介绍它的几个重要方法</p>
<p>timeToNextHeartbeat用于计算距离下一次心跳的剩余时间，比如还有3秒就要做下一次心跳<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">timeToNextHeartbeat</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 距离上一次心跳的时间</span></span><br><span class="line">    <span class="keyword">long</span> timeSinceLastHeartbeat = now - Math.max(lastHeartbeatSend, lastSessionReset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计划下一次心跳的时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> delayToNextHeartbeat;</span><br><span class="line">    <span class="keyword">if</span> (heartbeatFailed)</span><br><span class="line">        <span class="comment">// 失败，就是重试间隔</span></span><br><span class="line">        delayToNextHeartbeat = retryBackoffMs;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 正常的interval时间</span></span><br><span class="line">        delayToNextHeartbeat = heartbeatIntervalMs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 已经超出了计划心跳时间，需要立即心跳</span></span><br><span class="line">    <span class="keyword">if</span> (timeSinceLastHeartbeat &gt; delayToNextHeartbeat)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 按计划还有几秒进行下一次心跳</span></span><br><span class="line">        <span class="keyword">return</span> delayToNextHeartbeat - timeSinceLastHeartbeat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法用于Consumer端判断session是否过期，我想表达的意思是Coordinator端也会计算<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sessionTimeoutExpired</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 距离上次发送心跳成功的时间 是否大于sessionTimeout</span></span><br><span class="line">    <span class="keyword">return</span> now - Math.max(lastSessionReset, lastHeartbeatReceive) &gt; sessionTimeoutMs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法从字面意思理解为充值sessionTimeout起始时间点，大家可能觉得不好理解，我在这里直接说何时调用：获取到Coordinator，心跳线程暂停后重新启动(Consumer入组之后)<br>在这两个时间点重置起始时间点，大家应该好理解的多<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resetTimeouts</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lastSessionReset = now;</span><br><span class="line">    <span class="keyword">this</span>.lastPoll = now;</span><br><span class="line">    <span class="keyword">this</span>.heartbeatFailed = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="心跳线程"><a href="#心跳线程" class="headerlink" title="心跳线程"></a>心跳线程</h1><p>先看看HeartbeatThread类的全貌，它有enabled和closed两个变量，分别表示心跳线程的启动/暂停 和关闭，close只会在调用Consumer的close方法时触发，用于关闭资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">extends</span> <span class="title">KafkaThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;RuntimeException&gt; failed = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置线程名</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HeartbeatThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HEARTBEAT_THREAD_PREFIX + (groupId.isEmpty() ? <span class="string">""</span> : <span class="string">" | "</span> + groupId), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 入组之后</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">"Enabling heartbeat thread"</span>);</span><br><span class="line">            <span class="keyword">this</span>.enabled = <span class="keyword">true</span>;</span><br><span class="line">            heartbeat.resetTimeouts(time.milliseconds());</span><br><span class="line">            AbstractCoordinator.<span class="keyword">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 入组之前</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">"Disabling heartbeat thread"</span>);</span><br><span class="line">            <span class="keyword">this</span>.enabled = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭Consumer时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.closed = <span class="keyword">true</span>;</span><br><span class="line">            AbstractCoordinator.<span class="keyword">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是重要的run方法</p>
<h2 id="心跳核心方法"><a href="#心跳核心方法" class="headerlink" title="心跳核心方法"></a>心跳核心方法</h2><p>首先，Consumer是可以以多线程运行的，为了保证线程安全，以AbstractCoordinator.this为锁，除去几个简单的if判断，我们看看最长的if…else判断</p>
<ol>
<li>coordinator未知(为null或无法连接)时，会去查找coordinator，如果失败了，会等待，retryBackoffMs表示重试间隔</li>
<li>Consumer端计算sessionTimeout，标记coordinator未知</li>
<li>如果Consumer的两次poll间隔超过了maxPollIntervalMs，发起Leave Group请求</li>
<li>Heartbeat#timeToNextHeartbeat返回的时间为0，表示还没到心跳的时间，等待</li>
</ol>
<p>最后才会发起心跳请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">// 已关闭Consumer</span></span><br><span class="line">                <span class="keyword">if</span> (closed)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 离开了消费者组，或者被coordinator踢出了消费者组</span></span><br><span class="line">                <span class="comment">// 设置enabled=false</span></span><br><span class="line">                <span class="keyword">if</span> (!enabled) &#123;</span><br><span class="line">                    <span class="comment">// 看notify</span></span><br><span class="line">                    AbstractCoordinator.<span class="keyword">this</span>.wait();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 消费者组未到stable状态</span></span><br><span class="line">                <span class="keyword">if</span> (state != MemberState.STABLE) &#123;</span><br><span class="line">                    <span class="comment">// the group is not stable (perhaps because we left the group or because the coordinator</span></span><br><span class="line">                    <span class="comment">// kicked us out), so disable heartbeats and wait for the main thread to rejoin.</span></span><br><span class="line">                    disable();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                client.pollNoWakeup();</span><br><span class="line">                <span class="keyword">long</span> now = time.milliseconds();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (coordinatorUnknown()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (findCoordinatorFuture != <span class="keyword">null</span> || lookupCoordinator().failed())</span><br><span class="line">                        <span class="comment">// the immediate future check ensures that we backoff properly in the case that no</span></span><br><span class="line">                        <span class="comment">// brokers are available to connect to.</span></span><br><span class="line">                        <span class="comment">// 重试</span></span><br><span class="line">                        AbstractCoordinator.<span class="keyword">this</span>.wait(retryBackoffMs);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heartbeat.sessionTimeoutExpired(now)) &#123;</span><br><span class="line">                    <span class="comment">// the session timeout has expired without seeing a successful heartbeat, so we should</span></span><br><span class="line">                    <span class="comment">// probably make sure the coordinator is still healthy.</span></span><br><span class="line">                    <span class="comment">// 标记Coordinator未知，也在告诉了其他操作</span></span><br><span class="line">                    markCoordinatorUnknown();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heartbeat.pollTimeoutExpired(now)) &#123;</span><br><span class="line">                    <span class="comment">// 两次poll间隔超过了maxPollIntervalMs</span></span><br><span class="line">                    <span class="comment">// the poll timeout has expired, which means that the foreground thread has stalled</span></span><br><span class="line">                    <span class="comment">// in between calls to poll(), so we explicitly leave the group.</span></span><br><span class="line">                    maybeLeaveGroup();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!heartbeat.shouldHeartbeat(now)) &#123;</span><br><span class="line">                    <span class="comment">// timeToNextHeartbeat返回的时间还没到</span></span><br><span class="line">                    <span class="comment">// poll again after waiting for the retry backoff in case the heartbeat failed or the</span></span><br><span class="line">                    <span class="comment">// coordinator disconnected</span></span><br><span class="line">                    AbstractCoordinator.<span class="keyword">this</span>.wait(retryBackoffMs);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 记录心跳发送时间</span></span><br><span class="line">                    heartbeat.sentHeartbeat(now);</span><br><span class="line">                    <span class="comment">// 发送心跳</span></span><br><span class="line">                    sendHeartbeatRequest().addListener(<span class="keyword">new</span> RequestFutureListener&lt;Void&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Void value)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">                                <span class="comment">// 记录心跳接收时间</span></span><br><span class="line">                                heartbeat.receiveHeartbeat(time.milliseconds());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(RuntimeException e)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RebalanceInProgressException) &#123;</span><br><span class="line">                                    <span class="comment">// it is valid to continue heartbeating while the group is rebalancing. This</span></span><br><span class="line">                                    <span class="comment">// ensures that the coordinator keeps the member in the group for as long</span></span><br><span class="line">                                    <span class="comment">// as the duration of the rebalance timeout. If we stop sending heartbeats,</span></span><br><span class="line">                                    <span class="comment">// however, then the session timeout may expire before we can rejoin.</span></span><br><span class="line">                                    <span class="comment">// 在rebalance期间的心跳也算</span></span><br><span class="line">                                    heartbeat.receiveHeartbeat(time.milliseconds());</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    heartbeat.failHeartbeat();</span><br><span class="line">                                    <span class="comment">// 唤醒，找wait</span></span><br><span class="line">                                    <span class="comment">// wake up the thread if it's sleeping to reschedule the heartbeat</span></span><br><span class="line">                                    AbstractCoordinator.<span class="keyword">this</span>.notify();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 省略各种异常处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="心跳请求"><a href="#心跳请求" class="headerlink" title="心跳请求"></a>心跳请求</h3><p>HeartbeatRequest以groupId，generationId，消费者的memberId为参数，向coordinator发起请求<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> RequestFuture&lt;Void&gt; <span class="title">sendHeartbeatRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeartbeatRequest.Builder requestBuilder =</span><br><span class="line">            <span class="keyword">new</span> HeartbeatRequest.Builder(<span class="keyword">this</span>.groupId, <span class="keyword">this</span>.generation.generationId, <span class="keyword">this</span>.generation.memberId);</span><br><span class="line">    <span class="keyword">return</span> client.send(coordinator, requestBuilder)</span><br><span class="line">            .compose(<span class="keyword">new</span> HeartbeatResponseHandler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="coordinator处理心跳请求"><a href="#coordinator处理心跳请求" class="headerlink" title="coordinator处理心跳请求"></a>coordinator处理心跳请求</h1><p>依然是KafkaApis为入口，具体是handleHeartbeatRequest方法，认证相关省略，核心在coordinator的handleHeartbeat方法，为了节省篇幅，以下省略部分源码</p>
<p>当消费者组为stable状态时，主要调用completeAndScheduleNextHeartbeatExpiration，这里我保留了一个异常：UNKNOWN_MEMBER_ID，因为我经常看见它</p>
<p>The coordinator is not aware of this member</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">handleHeartbeat</span><span class="params">(groupId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      memberId: String,</span></span></span><br><span class="line"><span class="function"><span class="params">                      generationId: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                      responseCallback: Errors =&gt; Unit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 处理异常</span></span><br><span class="line"></span><br><span class="line">    groupManager.getGroup(groupId) match &#123;</span><br><span class="line">      <span class="keyword">case</span> None =&gt;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">case</span> <span class="title">Some</span><span class="params">(group)</span> </span>=&gt; group.inLock &#123;</span><br><span class="line">        group.currentState match &#123;</span><br><span class="line">          <span class="keyword">case</span> Dead =&gt;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> Empty =&gt;</span><br><span class="line">           </span><br><span class="line">          <span class="keyword">case</span> CompletingRebalance =&gt;</span><br><span class="line">           </span><br><span class="line">          <span class="keyword">case</span> PreparingRebalance =&gt;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> Stable =&gt;</span><br><span class="line">            <span class="keyword">if</span> (!group.has(memberId)) &#123;</span><br><span class="line">              responseCallback(Errors.UNKNOWN_MEMBER_ID)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (generationId != group.generationId) &#123;</span><br><span class="line">              responseCallback(Errors.ILLEGAL_GENERATION)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              val member = group.get(memberId)</span><br><span class="line">              completeAndScheduleNextHeartbeatExpiration(group, member)</span><br><span class="line">              responseCallback(Errors.NONE)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h3><p>该方法首先记录了Consumer心跳时间，计算下次心跳的deadline，如果下次心跳没有按时发送，就会被踢出消费者组，然后以groupId和memberId为key创建了一个延迟任务：DelayedHeartbeat<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">completeAndScheduleNextHeartbeatExpiration</span><span class="params">(group: GroupMetadata, member: MemberMetadata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// complete current heartbeat expectation</span></span><br><span class="line">    <span class="comment">// 记录消费者组成员心跳时间</span></span><br><span class="line">    member.latestHeartbeat = time.milliseconds()</span><br><span class="line">    <span class="comment">// delay key</span></span><br><span class="line">    val memberKey = MemberKey(member.groupId, member.memberId)</span><br><span class="line">    heartbeatPurgatory.checkAndComplete(memberKey)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reschedule the next heartbeat expiration deadline</span></span><br><span class="line">    <span class="comment">// 计算下次心跳的过期时间</span></span><br><span class="line">    val newHeartbeatDeadline = member.latestHeartbeat + member.sessionTimeoutMs</span><br><span class="line">    <span class="comment">// 放入延迟队列</span></span><br><span class="line">    val delayedHeartbeat = <span class="keyword">new</span> DelayedHeartbeat(<span class="keyword">this</span>, group, member, newHeartbeatDeadline, member.sessionTimeoutMs)</span><br><span class="line">    heartbeatPurgatory.tryCompleteElseWatch(delayedHeartbeat, Seq(memberKey))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="延迟任务DelayedHeartbeat"><a href="#延迟任务DelayedHeartbeat" class="headerlink" title="延迟任务DelayedHeartbeat"></a>延迟任务DelayedHeartbeat</h3><p>该延迟任务的tryComplete会判断Consumer的下次心跳时间还没到Deadline，就会取消该任务<br>重要的的是onExpireHeartbeat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private[group] class DelayedHeartbeat(coordinator: GroupCoordinator,</span><br><span class="line">                                      group: GroupMetadata,</span><br><span class="line">                                      member: MemberMetadata,</span><br><span class="line">                                      heartbeatDeadline: Long,</span><br><span class="line">                                      sessionTimeout: Long)</span><br><span class="line">  <span class="function">extends <span class="title">DelayedOperation</span><span class="params">(sessionTimeout, Some(group.lock)</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function">override def <span class="title">tryComplete</span><span class="params">()</span>: Boolean </span>= coordinator.tryCompleteHeartbeat(group, member, heartbeatDeadline, forceComplete _)</span><br><span class="line">  <span class="comment">// 过期处理，移出消费者组</span></span><br><span class="line">  <span class="function">override def <span class="title">onExpiration</span><span class="params">()</span> </span>= coordinator.onExpireHeartbeat(group, member, heartbeatDeadline)</span><br><span class="line">  <span class="comment">// 空实现</span></span><br><span class="line">  <span class="function">override def <span class="title">onComplete</span><span class="params">()</span> </span>= coordinator.onCompleteHeartbeat()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法首先从消费者组里移除了该Consumer，重新设置leader member，前文也说过了，leader member用于计算分区分配方案，<br>之后会触发rebalance操作，又回到了<a href="">kafka-rebalance之JoinGroup</a>一文的步骤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">onExpireHeartbeat</span><span class="params">(group: GroupMetadata, member: MemberMetadata, heartbeatDeadline: Long)</span> </span>&#123;</span><br><span class="line">    group.inLock &#123;</span><br><span class="line">      <span class="keyword">if</span> (!shouldKeepMemberAlive(member, heartbeatDeadline)) &#123;</span><br><span class="line">        info(s<span class="string">"Member $&#123;member.memberId&#125; in group $&#123;group.groupId&#125; has failed, removing it from the group"</span>)</span><br><span class="line">        removeMemberAndUpdateGroup(group, member)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">removeMemberAndUpdateGroup</span><span class="params">(group: GroupMetadata, member: MemberMetadata)</span> </span>&#123;</span><br><span class="line">    group.remove(member.memberId)</span><br><span class="line">    group.currentState match &#123;</span><br><span class="line">      <span class="keyword">case</span> Dead | Empty =&gt;</span><br><span class="line">      <span class="keyword">case</span> Stable | CompletingRebalance =&gt; maybePrepareRebalance(group)</span><br><span class="line">      <span class="keyword">case</span> PreparingRebalance =&gt; joinPurgatory.checkAndComplete(GroupKey(group.groupId))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="回到Consumer端的心跳线程"><a href="#回到Consumer端的心跳线程" class="headerlink" title="回到Consumer端的心跳线程"></a>回到Consumer端的心跳线程</h2><p>下面是Consumer对心跳请求的响应处理，这里主要是判断各类异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatResponseHandler</span> <span class="keyword">extends</span> <span class="title">CoordinatorResponseHandler</span>&lt;<span class="title">HeartbeatResponse</span>, <span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HeartbeatResponse heartbeatResponse, RequestFuture&lt;Void&gt; future)</span> </span>&#123;</span><br><span class="line">        sensors.heartbeatLatency.record(response.requestLatencyMs());</span><br><span class="line">        Errors error = heartbeatResponse.error();</span><br><span class="line">        <span class="keyword">if</span> (error == Errors.NONE) &#123;</span><br><span class="line">            log.debug(<span class="string">"Received successful Heartbeat response"</span>);</span><br><span class="line">            future.complete(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == Errors.COORDINATOR_NOT_AVAILABLE</span><br><span class="line">                || error == Errors.NOT_COORDINATOR) &#123;</span><br><span class="line">            log.info(<span class="string">"Attempt to heartbeat failed since coordinator &#123;&#125; is either not started or not valid."</span>,</span><br><span class="line">                    coordinator());</span><br><span class="line">            markCoordinatorUnknown();</span><br><span class="line">            future.raise(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == Errors.REBALANCE_IN_PROGRESS) &#123;</span><br><span class="line">            log.info(<span class="string">"Attempt to heartbeat failed since group is rebalancing"</span>);</span><br><span class="line">            requestRejoin();</span><br><span class="line">            future.raise(Errors.REBALANCE_IN_PROGRESS);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == Errors.ILLEGAL_GENERATION) &#123;</span><br><span class="line">            log.info(<span class="string">"Attempt to heartbeat failed since generation &#123;&#125; is not current"</span>, generation.generationId);</span><br><span class="line">            resetGeneration();</span><br><span class="line">            future.raise(Errors.ILLEGAL_GENERATION);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == Errors.UNKNOWN_MEMBER_ID) &#123;</span><br><span class="line">            log.info(<span class="string">"Attempt to heartbeat failed for since member id &#123;&#125; is not valid."</span>, generation.memberId);</span><br><span class="line">            resetGeneration();</span><br><span class="line">            future.raise(Errors.UNKNOWN_MEMBER_ID);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == Errors.GROUP_AUTHORIZATION_FAILED) &#123;</span><br><span class="line">            future.raise(<span class="keyword">new</span> GroupAuthorizationException(groupId));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            future.raise(<span class="keyword">new</span> KafkaException(<span class="string">"Unexpected error in heartbeat response: "</span> + error.message()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但这并没有结束, 在callback里，更新Heartbeat状态类的lastHeartbeatReceive变量，如果失败了则判断是否是在rebalance期间的心跳失败，如果是也算心跳成功，因为这属于被动失败，否则记为心跳失败，唤醒阻塞在AbstractCoordinator.this的线程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">sendHeartbeatRequest().addListener(<span class="keyword">new</span> RequestFutureListener&lt;Void&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Void value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// 记录心跳接收时间</span></span><br><span class="line">            heartbeat.receiveHeartbeat(time.milliseconds());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(RuntimeException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RebalanceInProgressException) &#123;</span><br><span class="line">                <span class="comment">// it is valid to continue heartbeating while the group is rebalancing. This</span></span><br><span class="line">                <span class="comment">// ensures that the coordinator keeps the member in the group for as long</span></span><br><span class="line">                <span class="comment">// as the duration of the rebalance timeout. If we stop sending heartbeats,</span></span><br><span class="line">                <span class="comment">// however, then the session timeout may expire before we can rejoin.</span></span><br><span class="line">                <span class="comment">// 在rebalance期间的心跳也算</span></span><br><span class="line">                heartbeat.receiveHeartbeat(time.milliseconds());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                heartbeat.failHeartbeat();</span><br><span class="line">                <span class="comment">// 唤醒，找wait</span></span><br><span class="line">                <span class="comment">// wake up the thread if it's sleeping to reschedule the heartbeat</span></span><br><span class="line">                AbstractCoordinator.<span class="keyword">this</span>.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">紫夜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://greedypirate.github.io/2020/05/15/kafka消费者-心跳流程全解析/">https://greedypirate.github.io/2020/05/15/kafka消费者-心跳流程全解析/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kafka/">kafka</a><a class="post-meta__tags" href="/tags/中间件/">中间件</a><a class="post-meta__tags" href="/tags/消息/">消息</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://ae01.alicdn.com/kf/H50b5d4d79e454447974210dae2d054435.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://ae01.alicdn.com/kf/H45f5b133580045879faaa5fcbe9b598fu.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b6532776de86c85" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/04/25/源码类文章阅读导航【置顶】/"><i class="fa fa-chevron-left">  </i><span>源码类文章阅读导航【置顶】</span></a></div><div class="next-post pull-right"><a href="/2020/05/02/kafka缓冲池-BufferPool-原理剖析/"><span>kafka缓冲池(BufferPool)原理剖析</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '0349a7a18b86f2a653e3',
  clientSecret: '567ba8cefbe2ecffbbc04e676652ae4b43e7f952',
  repo: 'GreedyPirate.github.io',
  owner: 'GreedyPirate',
  admin: 'GreedyPirate',
  id: md5(decodeURI(location.pathname)),
  language: ''
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By 紫夜</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://GreedyPirate.github.io">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>